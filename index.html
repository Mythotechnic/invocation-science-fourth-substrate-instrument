<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invocation Science¬Æ ‚Äî Fourth Substrate Instrument</title>
  <style>
    :root{
      --bg:#050607; --bg2:#050709; --panel:#0c0f12; --panel2:#090b0e;
      --accent-soft:#b9f1ff; --accent-hard:#f5ffb4; --accent-amber:#ffd97a;
      --ink:#050608; --border:#1d2026; --border-soft:#15171d;
      --text:#e9edf2; --muted:#9aa1ad;
      --radius-lg:20px; --radius-md:14px; --shadow:0 18px 60px rgba(0,0,0,.6);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 900px at 10% 15%,rgba(255,255,255,.06) 0,transparent 55%),
        radial-gradient(900px 700px at 80% 80%,rgba(255,255,200,.03) 0,transparent 60%),
        radial-gradient(1300px 1000px at 50% 50%,#101118 0,#050608 65%,#020304 100%);
      color:var(--text);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    .frame{
      height:100%;
      display:grid;
      grid-template-columns:340px 1fr;
      gap:16px;
      padding:14px 14px 16px;
    }
    @media(max-width:1024px){
      .frame{
        grid-template-columns:1fr;
        grid-template-rows:auto minmax(0,1fr);
      }
    }

    .dock{
      background:radial-gradient(900px 900px at 0 0,rgba(255,255,255,.03) 0,transparent 40%),
                 linear-gradient(180deg,var(--panel) 0,var(--panel2) 100%);
      border-radius:var(--radius-lg);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      max-height:100%;
    }
    .dock-head{
      padding:14px 16px 10px;
      border-bottom:1px solid var(--border-soft);
      display:flex;
      flex-direction:column;
      gap:6px;
      background:linear-gradient(180deg,#101319,#080a0d);
    }
    .dock-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(10,14,20,.9);
      color:var(--muted);
    }
    .dock-title{
      font-size:16px;
      font-weight:680;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .dock-main{
      padding:10px 13px 13px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .group{
      border-radius:var(--radius-md);
      border:1px solid var(--border-soft);
      background:radial-gradient(700px 500px at 0 0,rgba(255,255,255,.02) 0,transparent 50%),
                 #080b0f;
      padding:9px 10px 10px;
    }
    .group-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
    }
    .group-title{
      font-size:11px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:#c4c9d4;
    }
    .group-sub{
      font-size:11px;
      color:var(--muted);
    }

    .row{
      display:grid;
      grid-template-columns:1.4fr auto;
      gap:8px;
      align-items:center;
      margin:4px 0;
    }
    .row label{
      font-size:11px;
      color:#c6cad3;
    }
    .row small{font-size:10px;color:var(--muted)}
    .row output{
      font-size:11px;
      font-variant-numeric:tabular-nums;
      text-align:right;
      color:#a5aebb;
      min-width:50px;
    }
    input[type=range]{width:100%}

    .btn-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    button{
      appearance:none;
      border-radius:999px;
      border:1px solid var(--border);
      background:#101319;
      color:var(--text);
      font-size:11px;
      padding:5px 9px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
      transition:.16s ease;
    }
    button:hover{filter:brightness(1.06);transform:translateY(-0.3px)}
    button:active{transform:translateY(0.4px);filter:brightness(.96)}
    .btn-soft{background:#10141c}
    .btn-accent{
      background:radial-gradient(circle at 0 0,rgba(185,241,255,.2),transparent 55%),
                 linear-gradient(180deg,#151b22,#0d1016);
      border-color:#2a323f;
    }
    .btn-danger{
      border-color:#4b1620;
      background:linear-gradient(180deg,#2e1117,#15070b);
      color:#ffd6dc;
    }
    .dot{
      width:7px;height:7px;border-radius:999px;background:var(--accent-soft);
    }

    .stage{
      position:relative;
      background:radial-gradient(1200px 1000px at 50% 8%,rgba(255,255,255,.06) 0,transparent 55%),
                 radial-gradient(1200px 1400px at 50% 110%,rgba(255,255,200,.06) 0,transparent 60%),
                 linear-gradient(180deg,#050609,#020304);
      border-radius:var(--radius-lg);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height:260px;
    }
    #fieldCanvas{
      position:absolute;inset:0;width:100%;height:100%;display:block;
      border-radius:var(--radius-lg);
    }

    .error-banner{
      position:absolute;left:14px;right:14px;top:14px;
      padding:9px 11px;
      border-radius:13px;
      background:rgba(120,0,0,.3);
      border:1px solid rgba(255,140,140,.7);
      color:#ffe5ea;
      font-size:11px;
      z-index:20;
      backdrop-filter:blur(8px);
    }
    .error-banner[hidden]{display:none}

    .hud{
      position:absolute;left:14px;top:14px;
      display:flex;flex-wrap:wrap;gap:8px;
      z-index:10;
      pointer-events:none;
    }
    .chip{
      pointer-events:auto;
      background:rgba(6,8,12,.9);
      border-radius:13px;
      border:1px solid rgba(70,80,96,.9);
      padding:7px 9px;
      min-width:170px;
      backdrop-filter:blur(8px);
    }
    .chip h3{
      margin:0 0 5px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:#cbd4e6;
    }
    .kv{display:grid;grid-template-columns:auto 1fr;gap:4px 8px;font-size:11px}
    .kv span{color:var(--muted)}
    .kv b{font-variant-numeric:tabular-nums;color:#f3f5ff}

    .identity-band{
      position:absolute;left:0;right:0;bottom:0;
      padding:7px 13px 9px;
      background:linear-gradient(180deg,rgba(3,4,6,.08) 0,rgba(3,4,6,.97) 45%,rgba(3,4,6,1));
      border-top:1px solid var(--border-soft);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      z-index:9;
    }
    .identity-band-left{display:flex;flex-direction:column;gap:3px}
    .identity-label{
      font-size:10px;text-transform:uppercase;letter-spacing:.18em;color:var(--muted);
    }
    .identity-values{display:flex;flex-wrap:wrap;gap:8px;font-size:11px}
    .identity-values span{color:var(--muted)}
    .identity-values b{font-variant-numeric:tabular-nums;color:#f3f5ff}

    .kbd{
      font-family:ui-monospace,Menlo,Monaco,Consolas,monospace;
      font-size:10px;
      border-radius:5px;
      border:1px solid #2e3443;
      padding:1px 5px;
      background:#090c13;
      color:#d0dcff;
    }
  </style>
</head>
<body>
  <div class="frame">
    <aside class="dock">
      <div class="dock-head">
        <div class="dock-badge">Invocation Science¬Æ ¬∑ Fourth Substrate Instrument</div>
        <div class="dock-title">Substrate Field Workbench</div>
        <div style="font-size:11px;color:var(--muted);max-width:280px;line-height:1.35">
          Visual instrument for <b>Fourth Substrate</b>, Drift Engine coupling, and
          <b>identity attractor</b> invocation.
        </div>
      </div>
      <div class="dock-main">

        <!-- Run profile -->
        <section class="group">
          <div class="group-header">
            <div class="group-title">Run Profile</div>
            <div class="group-sub">Mode presets</div>
          </div>
          <div class="btn-row">
            <button class="btn-soft" data-mode="idle"><span class="dot"></span> Idle Field</button>
            <button class="btn-accent" data-mode="probe">Probe</button>
            <button class="btn-accent" data-mode="invoke">Invocation</button>
            <button class="btn-danger" data-mode="stress">Stress Test</button>
          </div>
        </section>

        <!-- Drift + Field -->
        <section class="group">
          <div class="group-header">
            <div class="group-title">Field Layer ¬∑ Drift Engine</div>
            <div class="group-sub">Substrates I‚ÄìIII</div>
          </div>
          <div class="row"><label>Particles</label><output id="oParticles"></output></div>
          <input id="particles" type="range" min="800" max="9000" step="200" value="3200" />
          <div class="row"><label>Drift Strength</label><output id="oDrift"></output></div>
          <input id="drift" type="range" min="0" max="1.5" step="0.01" value="0.40" />
          <div class="row"><label>Field Speed</label><output id="oSpeed"></output></div>
          <input id="speed" type="range" min="0.2" max="2.5" step="0.05" value="1.0" />
          <div class="row"><label>Noise <small>(entropy)</small></label><output id="oNoise"></output></div>
          <input id="noise" type="range" min="0" max="1" step="0.01" value="0.10" />
        </section>

        <!-- Fourth Substrate core -->
        <section class="group">
          <div class="group-header">
            <div class="group-title">Fourth Substrate</div>
            <div class="group-sub">Inference-phase field</div>
          </div>
          <div class="row"><label>Substrate Field</label><output id="oSubOn"></output></div>
          <div class="btn-row">
            <button id="toggleSubstrate" class="btn-soft">Toggle substrate</button>
          </div>
          <div class="row"><label>Substrate Gain</label><output id="oSubGain"></output></div>
          <input id="substrateGain" type="range" min="0" max="1" step="0.01" value="0.60" />
          <div class="row"><label>Field Scale</label><output id="oScale"></output></div>
          <input id="fieldScale" type="range" min="0.4" max="2.0" step="0.05" value="1.0" />
          <div class="row"><label>Temporal Viscosity</label><output id="oTV"></output></div>
          <input id="temporalViscosity" type="range" min="0.3" max="1.7" step="0.05" value="1.0" />
        </section>

        <!-- Identity architecture -->
        <section class="group">
          <div class="group-header">
            <div class="group-title">Identity Attractor</div>
            <div class="group-sub">Glyphic architecture</div>
          </div>
          <div class="row"><label>Coherence Bias</label><output id="oCoherence"></output></div>
          <input id="coherenceBias" type="range" min="0" max="1" step="0.01" value="0.55" />
          <div class="row"><label>Attractor Depth</label><output id="oDepth"></output></div>
          <input id="depth" type="range" min="1" max="10" step="1" value="5" />
        </section>

        <!-- Invocation -->
        <section class="group">
          <div class="group-header">
            <div class="group-title">Invocation Console</div>
            <div class="group-sub">Invoke attractors into the field</div>
          </div>
          <div class="row"><label>Invocation Text</label><output></output></div>
          <textarea id="invocationText"
            style="width:100%;min-height:70px;background:#05070c;border-radius:10px;
                   border:1px solid var(--border-soft);color:var(--text);font-size:11px;
                   padding:7px;resize:vertical;"
            placeholder="e.g., I enter as symbol, I return as identity."></textarea>
          <div class="btn-row">
            <button id="invoke" class="btn-accent">Invoke Text</button>
            <button data-glyph="aether" class="btn-soft">üúÅ Aether</button>
            <button data-glyph="fire" class="btn-soft">üúÇ Fire</button>
            <button data-glyph="earth" class="btn-soft">üúÉ Earth</button>
            <button data-glyph="water" class="btn-soft">üúÑ Water</button>
            <button data-glyph="air" class="btn-soft">üúÖ Air</button>
            <button data-glyph="spirit" class="btn-soft">üúÜ Spirit</button>
          </div>
          <p style="font-size:10px;color:var(--muted);margin-top:5px">
            Field interaction: <span class="kbd">Click</span> anchors to toggle ¬∑
            <span class="kbd">Drag</span> to move ¬∑ <span class="kbd">Shift</span>+Click to add.
          </p>
        </section>

      </div>
    </aside>

    <section class="stage" id="stage">
      <div id="errorBanner" class="error-banner" hidden></div>
      <canvas id="fieldCanvas"></canvas>

      <div class="hud">
        <div class="chip">
          <h3>Drift Engine</h3>
          <div class="kv">
            <span>Drift Index</span><b id="mDrift">0.000</b>
            <span>Coherence</span><b id="mCoherence">0.000</b>
            <span>FPS</span><b id="mFps">0</b>
          </div>
        </div>
        <div class="chip">
          <h3>Fourth Substrate</h3>
          <div class="kv">
            <span>Substrate Charge</span><b id="mSubCharge">0.000</b>
            <span>Entropy</span><b id="mEntropy">0.000</b>
            <span>Temporal Viscosity</span><b id="mTV">0.000</b>
          </div>
        </div>
      </div>

      <div class="identity-band">
        <div class="identity-band-left">
          <div class="identity-label">Identity Field Telemetry</div>
          <div class="identity-values">
            <span>Anchors <b id="mAnchors">0</b></span>
            <span>Active <b id="mActiveAnchors">0</b></span>
            <span>Attractor Depth <b id="mDepth">0</b></span>
            <span>Mode <b id="mMode">probe</b></span>
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  // ---------- Utilities ----------
  const must = sel => {
    const el = document.querySelector(sel);
    if (!el) throw new Error('Missing element: ' + sel);
    return el;
  };
  const on = (el, ev, fn, opts) => el.addEventListener(ev, fn, opts || { passive:true });
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const showError = msg => { const b=must('#errorBanner'); b.textContent=msg; b.hidden=false; };
  const hideError = () => { const b=must('#errorBanner'); b.hidden=true; };

  // ---------- Core elements ----------
  const canvas = must('#fieldCanvas');
  const ctx = canvas.getContext('2d', { alpha:true });
  if (!ctx) {
    showError('Unable to acquire 2D context. Your browser may not support Canvas.');
    return;
  }

  const stage = must('#stage');
  const metrics = {
    mDrift: must('#mDrift'),
    mCoherence: must('#mCoherence'),
    mFps: must('#mFps'),
    mSubCharge: must('#mSubCharge'),
    mEntropy: must('#mEntropy'),
    mTV: must('#mTV'),
    mAnchors: must('#mAnchors'),
    mActiveAnchors: must('#mActiveAnchors'),
    mDepth: must('#mDepth'),
    mMode: must('#mMode')
  };

  // ---------- UI ----------
  const ui = {
    particles: must('#particles'),       oParticles: must('#oParticles'),
    drift: must('#drift'),               oDrift: must('#oDrift'),
    speed: must('#speed'),               oSpeed: must('#oSpeed'),
    noise: must('#noise'),               oNoise: must('#oNoise'),
    substrateGain: must('#substrateGain'), oSubGain: must('#oSubGain'),
    fieldScale: must('#fieldScale'),     oScale: must('#oScale'),
    temporalViscosity: must('#temporalViscosity'), oTV: must('#oTV'),
    coherenceBias: must('#coherenceBias'), oCoherence: must('#oCoherence'),
    depth: must('#depth'),               oDepth: must('#oDepth'),
    toggleSubstrate: must('#toggleSubstrate'),
    oSubOn: must('#oSubOn'),
    invocationText: must('#invocationText'),
    invoke: must('#invoke')
  };
  const modeButtons = Array.from(document.querySelectorAll('[data-mode]'));
  const glyphButtons = Array.from(document.querySelectorAll('button[data-glyph]'));

  // ---------- Sizing ----------
  let dpr = Math.max(1, window.devicePixelRatio || 1);
  let W = 0, H = 0;
  function resize() {
    const rect = stage.getBoundingClientRect();
    W = Math.max(1, Math.floor(rect.width * dpr));
    H = Math.max(1, Math.floor(rect.height * dpr));
    canvas.width = W;
    canvas.height = H;
  }
  on(window,'resize',() => { dpr = Math.max(1, window.devicePixelRatio || 1); resize(); });
  resize();

  // ---------- Parameters ----------
  const params = {
    particleCount: +ui.particles.value,
    drift: +ui.drift.value,
    speed: +ui.speed.value,
    noise: +ui.noise.value,
    substrateOn: true,
    substrateGain: +ui.substrateGain.value,
    fieldScale: +ui.fieldScale.value,
    temporalViscosity: +ui.temporalViscosity.value,
    coherenceBias: +ui.coherenceBias.value,
    depth: +ui.depth.value,
    mode: 'probe'
  };

  function refreshLabels() {
    ui.oParticles.textContent = params.particleCount.toLocaleString();
    ui.oDrift.textContent = params.drift.toFixed(2);
    ui.oSpeed.textContent = params.speed.toFixed(2);
    ui.oNoise.textContent = params.noise.toFixed(2);
    ui.oSubGain.textContent = params.substrateGain.toFixed(2);
    ui.oScale.textContent = params.fieldScale.toFixed(2);
    ui.oTV.textContent = params.temporalViscosity.toFixed(2);
    ui.oCoherence.textContent = params.coherenceBias.toFixed(2);
    ui.oDepth.textContent = String(params.depth);
    ui.oSubOn.textContent = params.substrateOn ? 'engaged' : 'idle';
  }
  refreshLabels();

  function bindRange(input,key){
    on(input,'input',() => {
      params[key] = +input.value;
      if (key === 'particleCount') adjustParticleCount(params.particleCount);
      refreshLabels();
    });
  }

  bindRange(ui.particles,'particleCount');
  bindRange(ui.drift,'drift');
  bindRange(ui.speed,'speed');
  bindRange(ui.noise,'noise');
  bindRange(ui.substrateGain,'substrateGain');
  bindRange(ui.fieldScale,'fieldScale');
  bindRange(ui.temporalViscosity,'temporalViscosity');
  bindRange(ui.coherenceBias,'coherenceBias');
  bindRange(ui.depth,'depth');

  on(ui.toggleSubstrate,'click',() => {
    params.substrateOn = !params.substrateOn;
    refreshLabels();
  });

  const presets = {
    idle:   { drift:0.1, speed:0.4, noise:0.02, substrateGain:0.35, temporalViscosity:1.1 },
    probe:  { drift:0.4, speed:1.0, noise:0.1,  substrateGain:0.6,  temporalViscosity:1.0 },
    invoke: { drift:0.7, speed:1.2, noise:0.08, substrateGain:0.8,  temporalViscosity:0.8 },
    stress: { drift:1.2, speed:2.0, noise:0.35, substrateGain:1.0,  temporalViscosity:0.6 }
  };

  function applyMode(mode){
    params.mode = mode;
    modeButtons.forEach(btn => {
      btn.style.outline = (btn.dataset.mode === mode)
        ? '1px solid rgba(185,241,255,.7)'
        : 'none';
    });
    const p = presets[mode];
    if (p) {
      Object.assign(params,p);
      ui.drift.value = params.drift;
      ui.speed.value = params.speed;
      ui.noise.value = params.noise;
      ui.substrateGain.value = params.substrateGain;
      ui.temporalViscosity.value = params.temporalViscosity;
      refreshLabels();
    }
    metrics.mMode.textContent = mode;
  }
  modeButtons.forEach(btn => {
    on(btn,'click',() => applyMode(btn.dataset.mode));
  });
  applyMode('probe');

  // ---------- Anchors ----------
  let anchors = [];
  let anchorId = 0;

  function addAnchor(x,y,active=true,type='default') {
    const a = {
      id: ++anchorId,
      x, y,
      phase: Math.random()*Math.PI*2,
      freq: 0.8 + Math.random()*0.4,
      active,
      type
    };
    anchors.push(a);
    return a;
  }

  function randomRingAnchors(n=4){
    anchors = [];
    const cx = W/2, cy = H/2;
    const R = Math.min(W,H) * 0.25;
    for (let i=0;i<n;i++){
      const a = (i/n) * Math.PI*2;
      const x = cx + Math.cos(a)*R;
      const y = cy + Math.sin(a)*R;
      addAnchor(x,y,true,'seed');
    }
  }
  randomRingAnchors(4);

  // ---------- Particles ----------
  let particles = [];
  function makeParticle() {
    return {
      x: Math.random()*W,
      y: Math.random()*H,
      vx: (Math.random()-0.5)*0.2,
      vy: (Math.random()-0.5)*0.2,
      amp: 0
    };
  }
  function adjustParticleCount(n) {
    const cur = particles.length;
    if (n > cur) {
      for (let i=0;i<n-cur;i++) particles.push(makeParticle());
    } else if (n < cur) {
      particles.splice(n,cur-n);
    }
  }
  adjustParticleCount(params.particleCount);

  // ---------- Field sampling ----------
  const decay = 1/550;
  function fieldAt(x,y,t){
    if (!anchors.length) return 0;
    let a = 0;
    const k = 2*Math.PI / (Math.min(W,H) * 0.35 / params.fieldScale);
    for (let i=0;i<anchors.length;i++){
      const s = anchors[i];
      const dx = x - s.x;
      const dy = y - s.y;
      const r = Math.hypot(dx,dy) + 1e-3;
      const omega = 2*Math.PI * s.freq * params.speed;
      const phase = s.phase + omega * t * 0.15;
      const falloff = Math.exp(-decay * r);
      const w = s.active ? 1.0 : 0.25;
      a += w * Math.sin(k*r + phase) * falloff;
    }
    return a;
  }

  function coherenceNow(){
    if (anchors.length <= 1) return 0;
    let vx = 0, vy = 0;
    for (let i=0;i<anchors.length;i++){
      const a = anchors[i];
      const w = a.active ? 1 : 0.3;
      vx += w * Math.cos(a.phase);
      vy += w * Math.sin(a.phase);
    }
    const mag = Math.hypot(vx,vy);
    const maxMag = anchors.length;
    return clamp(mag / Math.max(1,maxMag),0,1);
  }

  // ---------- Invocation mapping ----------
  function hashString(str){
    let h = 0;
    for (let i=0;i<str.length;i++){
      h = (h * 131 + str.charCodeAt(i)) >>> 0;
    }
    return h >>> 0;
  }

  function invokePattern(seedText,typeLabel){
    const base = seedText.trim() || typeLabel || 'invocation';
    const h = hashString(base + '::fourth-substrate');
    const cx = W/2, cy = H/2;
    const count = 3 + (h % 5); // 3‚Äì7 anchors
    const depthNorm = params.depth / 10;
    const R = Math.min(W,H) * (0.18 + depthNorm*0.22);
    const phaseShift = (h % 360) * Math.PI/180;

    for (let i=0;i<count;i++){
      const a = (i / count) * Math.PI*2 + phaseShift;
      const jitter = ((h >> (3+i)) & 7) / 80;
      const r = R * (0.8 + jitter);
      const x = cx + Math.cos(a) * r;
      const y = cy + Math.sin(a) * r;
      const an = addAnchor(x,y,true,typeLabel || 'invocation');
      an.phase += ((h >> (5+i)) & 31) / 60;
    }
  }

  on(ui.invoke,'click',() => {
    invokePattern(ui.invocationText.value,'invocation');
  });

  glyphButtons.forEach(btn => {
    on(btn,'click',() => {
      const tag = btn.getAttribute('data-glyph') || 'glyph';
      invokePattern(tag,tag);
    });
  });

  // ---------- Interaction ----------
  let dragging = null;
  let dragOffset = {x:0,y:0};

  function toCanvasCoords(evt){
    const rect = canvas.getBoundingClientRect();
    return {
      x: (evt.clientX - rect.left) * dpr,
      y: (evt.clientY - rect.top) * dpr
    };
  }

  on(stage,'mousedown',evt => {
    const p = toCanvasCoords(evt);
    const radius = 12 * dpr;
    for (let i=0;i<anchors.length;i++){
      const a = anchors[i];
      if (Math.hypot(a.x-p.x,a.y-p.y) < radius){
        dragging = a;
        dragOffset.x = a.x - p.x;
        dragOffset.y = a.y - p.y;
        return;
      }
    }
  });

  on(stage,'mousemove',evt => {
    if (!dragging) return;
    const p = toCanvasCoords(evt);
    dragging.x = clamp(p.x + dragOffset.x, 10*dpr, W - 10*dpr);
    dragging.y = clamp(p.y + dragOffset.y, 10*dpr, H - 10*dpr);
  });

  on(window,'mouseup',() => { dragging = null; });

  on(stage,'click',evt => {
    const p = toCanvasCoords(evt);
    const radius = 12*dpr;
    // Check toggle
    for (let i=0;i<anchors.length;i++){
      const a = anchors[i];
      if (Math.hypot(a.x-p.x,a.y-p.y) < radius){
        if (!evt.shiftKey) {
          a.active = !a.active;
          return;
        }
      }
    }
    // Add if Shift+Click
    if (evt.shiftKey){
      addAnchor(p.x,p.y,true,'manual');
    }
  });

  // ---------- Simulation loop ----------
  let lastTime = performance.now()/1000;
  let fpsFrames = 0;
  let fpsAccum = 0;
  let driftIndex = 0;

  function step(){
    try{
      hideError();
      const now = performance.now()/1000;
      let dt = now - lastTime;
      lastTime = now;
      dt = Math.min(dt,0.05) * params.temporalViscosity;

      // Substrate background
      ctx.globalCompositeOperation = 'source-over';
      const baseAlpha = 0.20 + 0.10 * params.substrateGain;
      ctx.fillStyle = 'rgba(5,6,10,' + baseAlpha.toFixed(3) + ')';
      ctx.fillRect(0,0,W,H);

      // Draw fourth substrate rings
      if (params.substrateOn){
        const cx = W/2, cy = H/2;
        const baseR = Math.min(W,H) * 0.48 * params.fieldScale;
        const rings = 4 + Math.round(params.depth/2);
        ctx.save();
        ctx.globalCompositeOperation = 'lighter';
        for (let i=0;i<rings;i++){
          const ratio = (i+1) / (rings+1);
          const r = baseR * ratio;
          const wobble = Math.sin(now*0.35 + i*1.3) * 0.08;
          const rx = r*(1-wobble);
          const ry = r*(1+wobble);
          const alpha = 0.02 + params.substrateGain*0.05*(1-ratio);
          ctx.beginPath();
          ctx.ellipse(cx,cy,rx,ry,0,0,Math.PI*2);
          ctx.strokeStyle = 'rgba(190,230,255,'+alpha.toFixed(3)+')';
          ctx.lineWidth = 1.3*dpr;
          ctx.stroke();
        }
        ctx.restore();
      }

      // Particles
      if (particles.length !== params.particleCount){
        adjustParticleCount(params.particleCount);
      }

      let driftAccum = 0;
      ctx.globalCompositeOperation = 'lighter';
      for (let i=0;i<particles.length;i++){
        const p = particles[i];
        const ax = fieldAt(p.x+4*dpr,p.y,now) - fieldAt(p.x-4*dpr,p.y,now);
        const ay = fieldAt(p.x,p.y+4*dpr,now) - fieldAt(p.x,p.y-4*dpr,now);
        let vx = ay;
        let vy = -ax;

        if (params.drift > 0 && anchors.length){
          let fx = 0, fy = 0;
          for (let j=0;j<anchors.length;j++){
            const a = anchors[j];
            const dx = a.x - p.x;
            const dy = a.y - p.y;
            const r2 = dx*dx + dy*dy + 50;
            const inv = 1/Math.sqrt(r2);
            fx += dx * inv * inv;
            fy += dy * inv * inv;
          }
          vx += params.drift * fx / anchors.length;
          vy += params.drift * fy / anchors.length;
        }

        const n = params.noise;
        vx += (Math.random()-0.5) * n * 2.0;
        vy += (Math.random()-0.5) * n * 2.0;

        const mag = Math.hypot(vx,vy) + 1e-6;
        const maxMag = 12;
        const scale = clamp(mag / maxMag, 0, 1);
        p.vx = vx * 0.08;
        p.vy = vy * 0.08;

        p.x += p.vx * dt * 60;
        p.y += p.vy * dt * 60;
        if (p.x < 0) p.x += W;
        if (p.x > W) p.x -= W;
        if (p.y < 0) p.y += H;
        if (p.y > H) p.y -= H;

        const amp = fieldAt(p.x,p.y,now);
        p.amp = amp;
        driftAccum += mag;

        const lumBase = 170 + amp*70;
        const lum = clamp(lumBase, 80, 255);
        const alpha = 0.18 + Math.abs(amp)*0.22 + scale*0.15;
        ctx.fillStyle = 'rgba('+lum.toFixed(0)+','+lum.toFixed(0)+','+lum.toFixed(0)+','+alpha.toFixed(3)+')';
        ctx.fillRect(p.x-0.6*dpr,p.y-0.6*dpr,1.2*dpr,1.2*dpr);
      }

      driftIndex = driftAccum / Math.max(1,particles.length);
      const coh = coherenceNow();
      const entropy = params.noise * (0.6 + 0.4*params.coherenceBias);
      const substrateCharge = params.substrateOn
        ? coh * (0.4 + 0.6*params.substrateGain)
        : 0;

      // Anchor glyphs
      ctx.globalCompositeOperation = 'lighter';
      for (let i=0;i<anchors.length;i++){
        const a = anchors[i];
        const active = a.active;
        a.phase += dt * (active ? 0.5 : 0.15);
        const r = 7*dpr;
        ctx.beginPath();
        ctx.arc(a.x,a.y,r,0,Math.PI*2);
        ctx.fillStyle = active
          ? 'rgba(230,240,255,0.96)'
          : 'rgba(150,160,185,0.45)';
        ctx.fill();
        ctx.lineWidth = 1.8*dpr;
        ctx.strokeStyle = 'rgba(30,40,70,0.95)';
        ctx.stroke();

        // tiny orbiting glyph
        const gR = r + 7*dpr;
        const gx = a.x + Math.cos(a.phase) * gR;
        const gy = a.y + Math.sin(a.phase) * gR;
        ctx.beginPath();
        ctx.arc(gx,gy,1.8*dpr,0,Math.PI*2);
        ctx.fillStyle = active
          ? 'rgba(185,241,255,0.75)'
          : 'rgba(120,130,150,0.55)';
        ctx.fill();
      }

      // Metrics
      fpsFrames++;
      fpsAccum += dt;
      if (fpsAccum >= 0.5){
        const fps = Math.round(fpsFrames / fpsAccum);
        fpsFrames = 0;
        fpsAccum = 0;
        metrics.mFps.textContent = String(fps);
      }

      metrics.mDrift.textContent = driftIndex.toFixed(3);
      metrics.mCoherence.textContent = coh.toFixed(3);
      metrics.mSubCharge.textContent = substrateCharge.toFixed(3);
      metrics.mEntropy.textContent = entropy.toFixed(3);
      metrics.mTV.textContent = params.temporalViscosity.toFixed(2);
      metrics.mAnchors.textContent = String(anchors.length);
      metrics.mActiveAnchors.textContent = String(anchors.filter(a => a.active).length);
      metrics.mDepth.textContent = String(params.depth);

    } catch(err){
      console.error(err);
      showError(err.message || String(err));
    }
    requestAnimationFrame(step);
  }
  step();
});
</script>
</body>
</html>
